import{_ as fe,r as p,k as se,K as me,c as A,o as x,b as n,B as R,f as a,s as D,d as K,y as ve,z as ye,A as z,a as l,q as P,x as we,t as N,T as he,L as be,M as xe,i as ge,j as I,N as G,p as _e,l as c,h as ke,g as M,m as Ce,n as $e,e as O,w as ee}from"./index-CERIRcW2.js";import{s as H,a as v}from"./index-XVpHQhPD.js";import{s as Ae}from"./index-CFQQnXSI.js";import{s as De,a as Ne}from"./index-U7OHyoop.js";import{s as te}from"./index-DSoLdR8G.js";import{s as Le}from"./index-BSCWIYhD.js";import{s as Fe}from"./index-BNKFRcfd.js";import{s as Se}from"./index-uhg5r1Ll.js";import"./index-yWIa-DpI.js";import"./index-DBcSeseI.js";import"./index-CUPv0TyI.js";const qe=["onClick"],Ve={key:1},Ee=["onClick"],Me={__name:"DropdownMenu",props:{options:Array},emits:["select"],setup(Q,{emit:U}){const g=p({}),f=p(null),W=U,w=p(!1),C=p(null),L=Math.random().toString(36).substr(2,9),$=p("");function h(u){!C.value||u&&C.value.contains(u.target)||(w.value=!1)}function F(){w.value=!1}function T(){window.dispatchEvent(new CustomEvent("dropdownmenu:open",{detail:L})),w.value=!0,be(()=>{const u=C.value.getBoundingClientRect(),_=f.value;if(!_)return;const m=_.offsetHeight,k=window.innerHeight-u.bottom,E=u.top,S=k<m&&E>k;$.value=S?"upwards":"",g.value={position:"absolute",top:S?`${u.top+window.scrollY-m-8}px`:`${u.bottom+window.scrollY+8}px`,left:`${u.right+window.scrollX-_.offsetWidth}px`,zIndex:9999}})}function Y(){w.value?w.value=!1:T()}function B(u){w.value=!1,W("select",u)}function V(u){u.detail!==L&&(w.value=!1)}return se(()=>{document.addEventListener("mousedown",h),window.addEventListener("dropdownmenu:open",V),window.addEventListener("scroll",F,!0)}),me(()=>{document.removeEventListener("mousedown",h),window.removeEventListener("dropdownmenu:open",V),window.removeEventListener("scroll",F,!0)}),(u,_)=>(x(),A("div",{class:"relative inline-block",ref_key:"root",ref:C},[n(a(D),{icon:"pi pi-ellipsis-v",text:"",rounded:"",onClick:Y}),(x(),R(he,{to:"body"},[w.value?(x(),A("div",{key:0,ref_key:"menuRef",ref:f,class:z(["dropdown-menu-popup",$.value]),style:ye(g.value),onMousedown:_[0]||(_[0]=ve(()=>{},["stop"]))},[l("ul",null,[(x(!0),A(P,null,we(Q.options,m=>(x(),A(P,{key:m.label},[m.action!=="delete"?(x(),A("li",{key:0,class:"dropdown-menu-item",onClick:k=>B(m)},[l("i",{class:z(m.icon+" dropdown-menu-icon")},null,2),l("span",null,N(m.label),1)],8,qe)):(x(),A("li",Ve,[_[1]||(_[1]=l("div",{class:"dropdown-menu-divider"},null,-1)),l("div",{class:"dropdown-menu-item dropdown-menu-delete",onClick:k=>B(m)},[l("i",{class:z(m.icon+" dropdown-menu-icon")},null,2),l("span",null,N(m.label),1)],8,Ee)]))],64))),128))])],38)):K("",!0)]))],512))}},Re=fe(Me,[["__scopeId","data-v-1b27d39b"]]),Ye={class:"space-y-6"},Be={class:"flex flex-col gap-4"},Ie={class:"text-2xl font-bold text-surface-900 dark:text-surface-0"},Ue={class:"grid grid-cols-4 gap-3 items-center"},We={class:"md:col-span-1"},Te={class:"md:col-span-1"},je={class:"col-span-2 w-full flex justify-end"},ze={class:"card bg-white dark:bg-surface-800 rounded-xl shadow-sm p-4"},Ge={key:0},Oe={key:1,class:"text-surface-400 italic"},He={class:"flex gap-2"},Ke={class:"flex align-items-center gap-2"},Pe={class:"mb-4"},Qe={class:"flex flex-col gap-6 py-2 px-2"},Xe={class:"flex justify-end gap-3 pt-2"},dt={__name:"FileList",setup(Q){const U=xe(),g=ke(),f=_e(),W=ge(),w=p([]),C=p([]),L=p(!1),$=p(""),h=p(null),F=p([]),T=I(()=>F.value.map(t=>({label:t,value:t})));function Y(){const t=new Date,e=t.getFullYear();return t.getMonth()>=3?`${e}-${e+1}`:`${e-1}-${e}`}function B(){const t={...f.query};h.value?t.year=h.value:delete t.year,g.replace({query:t})}const V=p(!1),u=p(null),_=p([]),m=p(!1),k=p(!1),E=p({reason:"",assessment_year:""}),S=I(()=>{var t,e;return(e=(t=W.user)==null?void 0:t.roles)==null?void 0:e.some(o=>o.name==="admin"||o.name==="manager")}),ae=I(()=>{if(!$.value)return w.value;const t=$.value.toLowerCase();return w.value.filter(e=>{var o,s,y,b,r,i;return((o=e.file_type)==null?void 0:o.toLowerCase().includes(t))||((y=(s=e.client)==null?void 0:s.business_name)==null?void 0:y.toLowerCase().includes(t))||((b=e.assessment_year)==null?void 0:b.toLowerCase().includes(t))||((r=e.financial_year)==null?void 0:r.toLowerCase().includes(t))||((i=e.status)==null?void 0:i.toLowerCase().includes(t))})}),le=I(()=>{if(!$.value)return C.value;const t=$.value.toLowerCase();return C.value.filter(e=>{var o,s,y,b;return((o=e.business_name)==null?void 0:o.toLowerCase().includes(t))||((s=e.contact_person)==null?void 0:s.toLowerCase().includes(t))||((y=e.email)==null?void 0:y.toLowerCase().includes(t))||((b=e.phone)==null?void 0:b.toLowerCase().includes(t))})}),j=async()=>{L.value=!0;try{const t=f.query.status,e=f.query.year,o=f.query.time_period,s=f.query.employee_id;if(t==="unreceived"){const{data:y}=await M.get("/clients"),{data:b}=await M.get("/files");F.value=Array.from(new Set(b.map(d=>d.assessment_year).filter(Boolean))).sort().reverse();let r=e?b.filter(d=>d.assessment_year===e):[...b];if(o){const d=new Date;let q=null;o.endsWith("d")?q=new Date(d-parseInt(o)*24*60*60*1e3):o.endsWith("w")?q=new Date(d-parseInt(o)*7*24*60*60*1e3):(o.endsWith("h")||o.endsWith("hr"))&&(q=new Date(d-parseInt(o)*60*60*1e3)),q&&(r=r.filter(pe=>new Date(pe.created_at)>=q))}const i=new Set(r.map(d=>d.client_id));C.value=y.filter(d=>!i.has(d.id)),w.value=[]}else{let b=(await M.get("/files")).data;F.value=Array.from(new Set(b.map(i=>i.assessment_year).filter(Boolean))).sort().reverse();let r=b;if(t&&t!=="all"&&(t==="payment_received"?r=r.filter(i=>i.status==="payment_received"&&i.payment_id!==null):t==="pending"?r=r.filter(i=>i.status!=="completed"&&i.status!=="filed"):r=r.filter(i=>i.status===t)),e&&(r=r.filter(i=>i.assessment_year===e)),s&&["all","received","pending","in-progress","completed","ready-to-file"].includes(t)&&(r=r.filter(i=>i.assigned_to==s)),o){const i=new Date;let d=null;o.endsWith("d")?d=new Date(i.getTime()-parseInt(o)*864e5):o.endsWith("w")?d=new Date(i.getTime()-parseInt(o)*6048e5):(o.endsWith("h")||o.endsWith("hr"))&&(d=new Date(i.getTime()-parseInt(o)*36e5)),d&&(r=r.filter(q=>new Date(q.created_at)>=d))}w.value=r.sort((i,d)=>d.id-i.id),C.value=[]}w.value.sort((y,b)=>b.id-y.id)}catch(t){console.error("Error fetching files:",t)}finally{L.value=!1}},X=async t=>{u.value=t,V.value=!0,await Z(t.id)},Z=async t=>{m.value=!0;try{const e=await M.get(`/clients/${t}/notes`,{params:{assessment_year:h.value}});_.value=e.data}catch(e){console.error("Error fetching client notes:",e)}finally{m.value=!1}},ne=()=>{if(!h.value){console.warn("No assessment year selected");return}E.value={reason:"",assessment_year:h.value},k.value=!0},oe=async()=>{if(!h.value){console.warn("Cannot save note without assessment year");return}try{const t={reason:E.value.reason,assessment_year:h.value};await M.post(`/clients/${u.value.id}/notes`,t),k.value=!1,await Z(u.value.id)}catch(t){console.error("Error saving note:",t)}},ie=t=>t?new Date(t).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",re=t=>{switch(t){case"completed":return"success";case"filed":return"success";case"ready-to-file":return"info";case"in-progress":return"info";case"assigned":return"secondary";case"received":return"secondary";default:return"secondary"}};function de(t){const e=[];return S.value&&e.push({label:"Edit",icon:"pi pi-pencil",action:"edit"}),e.push({label:"View",icon:"pi pi-eye",action:"view"}),t.client&&e.push({label:"Notes",icon:"pi pi-file",action:"notes"}),S.value&&e.push({label:"Delete",icon:"pi pi-trash",action:"delete",class:"text-danger"}),e}function ue(t,e){switch(t.action){case"edit":g.push(`/files/${e.id}/edit`);break;case"view":g.push(`/files/${e.id}`);break;case"notes":X(e.client);break;case"delete":ce(e);break}}const ce=t=>{U.require({message:`Are you sure you want to delete this file (${t.file_type} - ${t.assessment_year})?`,header:"Confirm Delete",icon:"pi pi-exclamation-triangle",acceptClass:"p-button-danger",accept:async()=>{try{await M.delete(`/files/${t.id}`),await j()}catch(e){console.error("Error deleting file:",e)}}})};G(()=>f.fullPath,()=>{j(),h.value=f.query.year??null},{immediate:!0});const J=p(!1);return G(F,t=>{if(!t.length||J.value||f.query.year)return;const e=t.includes(Y())?Y():t[0];J.value=!0,g.replace({query:{...f.query,year:e}})},{immediate:!0}),G(h,t=>{t&&t!==f.query.year&&g.replace({query:{...f.query,year:t}})}),se(j),(t,e)=>{const o=Ce("tooltip");return x(),A(P,null,[n(a(Fe)),l("div",Ye,[l("div",Be,[l("h2",Ie,N(a(f).query.status==="unreceived"?"Unreceived Files":"All Files"),1),e[10]||(e[10]=l("hr",null,null,-1)),l("div",Ue,[l("div",We,[e[8]||(e[8]=l("label",{class:"block mb-2 text-sm font-medium text-surface-700 dark:text-surface-300"}," Search Filter ",-1)),n(a(De),{iconPosition:"left",class:"w-full"},{default:c(()=>[n(a(Ne),{class:"pi pi-search"}),n(a($e),{modelValue:$.value,"onUpdate:modelValue":e[0]||(e[0]=s=>$.value=s),placeholder:"Search...",class:"w-full"},null,8,["modelValue"])]),_:1})]),l("div",Te,[e[9]||(e[9]=l("label",{class:"block mb-2 text-sm font-medium text-surface-700 dark:text-surface-300"}," Assessment Year ",-1)),n(a(Se),{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s),options:T.value,optionLabel:"label",optionValue:"value",placeholder:"Assessment Year",class:"w-full",onChange:B,clearable:!0},null,8,["modelValue","options"])]),l("div",je,[S.value?(x(),R(a(D),{key:0,label:"Add File",icon:"pi pi-plus",class:"whitespace-nowrap",onClick:e[2]||(e[2]=s=>a(g).push("/files/create"))})):K("",!0)])])]),l("div",ze,[a(f).query.status!=="unreceived"?(x(),R(a(H),{key:0,value:ae.value,loading:L.value,paginator:"",rows:10,tableStyle:"min-width: 50rem",stripedRows:"",showGridlines:!1,class:"p-datatable-sm"},{empty:c(()=>[...e[11]||(e[11]=[l("div",{class:"text-center p-8"},[l("i",{class:"pi pi-inbox text-4xl text-surface-400 mb-4"}),l("h3",{class:"text-xl font-semibold text-surface-700 dark:text-surface-300 mb-2"},"No Files Found"),l("p",{class:"text-surface-500 dark:text-surface-400"}," No files match your current filters. ")],-1)])]),default:c(()=>[n(a(v),{field:"file_type",header:"File Type",sortable:""}),n(a(v),{field:"client.business_name",header:"Client",sortable:""}),n(a(v),{field:"assessment_year",header:"Assessment Year",sortable:""}),n(a(v),{field:"estimated_completion_date",header:"Est. Completion Date",sortable:""},{body:c(s=>[O(N(s.data.estimated_completion_date||"-"),1)]),_:1}),n(a(v),{field:"turnover",header:"Turnover",sortable:""},{body:c(s=>[O(N(s.data.turnover||"-"),1)]),_:1}),n(a(v),{header:"Status"},{body:c(s=>[n(a(Ae),{value:s.data.status,severity:re(s.data.status)},null,8,["value","severity"])]),_:1}),n(a(v),{header:"Assignee"},{body:c(s=>[s.data.assignee?(x(),A("span",Ge,N(s.data.assignee.name),1)):(x(),A("span",Oe,"Unassigned"))]),_:1}),n(a(v),{header:"Actions"},{body:c(s=>[n(Re,{options:de(s.data),onSelect:y=>ue(y,s.data)},null,8,["options","onSelect"])]),_:1})]),_:1},8,["value","loading"])):(x(),R(a(H),{key:1,value:le.value,loading:L.value,paginator:"",rows:10,tableStyle:"min-width: 50rem",stripedRows:"",showGridlines:!1,class:"p-datatable-sm"},{empty:c(()=>[...e[12]||(e[12]=[l("div",{class:"text-center p-8"},[l("i",{class:"pi pi-users text-4xl text-surface-400 mb-4"}),l("h3",{class:"text-xl font-semibold text-surface-700 dark:text-surface-300 mb-2"},"No Clients Found"),l("p",{class:"text-surface-500 dark:text-surface-400"}," All clients have submitted files for this period. ")],-1)])]),default:c(()=>[n(a(v),{field:"business_name",header:"Business Name",sortable:""}),n(a(v),{field:"contact_person",header:"Contact Person",sortable:""}),n(a(v),{field:"email",header:"Email",sortable:""}),n(a(v),{field:"phone",header:"Phone",sortable:""}),n(a(v),{header:"Actions"},{body:c(s=>[l("div",He,[n(a(D),{icon:"pi pi-eye",text:"",rounded:"",severity:"secondary",onClick:y=>a(g).push(`/clients/${s.data.id}`)},null,8,["onClick"]),ee(n(a(D),{icon:"pi pi-file",text:"",rounded:"",severity:"info",onClick:y=>X(s.data)},null,8,["onClick"]),[[o,"View Notes"]]),S.value?ee((x(),R(a(D),{key:0,icon:"pi pi-plus",text:"",rounded:"",severity:"success",onClick:e[3]||(e[3]=y=>a(g).push("/files/create"))},null,512)),[[o,"Add File for this client"]]):K("",!0)])]),_:1})]),_:1},8,["value","loading"]))]),n(a(te),{visible:V.value,"onUpdate:visible":e[4]||(e[4]=s=>V.value=s),modal:"",header:"Client Notes",style:{width:"50rem"}},{header:c(()=>{var s;return[l("div",Ke,[e[13]||(e[13]=l("i",{class:"pi pi-file"},null,-1)),l("span",null,"Notes for "+N((s=u.value)==null?void 0:s.business_name),1)])]}),default:c(()=>[l("div",Pe,[n(a(D),{label:"Add Note",icon:"pi pi-plus",onClick:ne})]),n(a(H),{value:_.value,loading:m.value,stripedRows:"",showGridlines:!1,class:"p-datatable-sm"},{empty:c(()=>[...e[14]||(e[14]=[l("div",{class:"text-center p-4"},[l("i",{class:"pi pi-info-circle text-4xl text-surface-400 mb-4"}),l("h3",{class:"text-xl font-semibold text-surface-700 dark:text-surface-300 mb-2"},"No Notes Found"),l("p",{class:"text-surface-500 dark:text-surface-400"}," No notes have been added for this client yet. ")],-1)])]),default:c(()=>[n(a(v),{field:"reason",header:"Reason",style:{"min-width":"200px"}}),n(a(v),{field:"user.name",header:"User",style:{"min-width":"120px"}}),n(a(v),{field:"created_at",header:"Last Contacted",style:{"min-width":"120px"}},{body:c(s=>[O(N(ie(s.data.created_at)),1)]),_:1})]),_:1},8,["value","loading"])]),_:1},8,["visible"]),n(a(te),{visible:k.value,"onUpdate:visible":e[7]||(e[7]=s=>k.value=s),modal:"",header:"Add Note",style:{width:"32rem",padding:"2rem"},class:"add-note-dialog"},{footer:c(()=>[l("div",Xe,[n(a(D),{label:"Cancel",icon:"pi pi-times",text:"",onClick:e[6]||(e[6]=s=>k.value=!1),class:"px-4 py-2 text-base"}),n(a(D),{label:"Save",icon:"pi pi-check",onClick:oe,loading:m.value,class:"px-4 py-2 text-base"},null,8,["loading"])])]),default:c(()=>[l("div",Qe,[l("div",null,[e[15]||(e[15]=l("label",{for:"reason",class:"block text-base font-semibold mb-2 text-surface-900 dark:text-surface-100"},"Reason *",-1)),n(a(Le),{id:"reason",modelValue:E.value.reason,"onUpdate:modelValue":e[5]||(e[5]=s=>E.value.reason=s),rows:"6",class:"w-full rounded-lg border border-surface-200 focus:border-primary-500 transition-all",style:{"min-height":"120px"}},null,8,["modelValue"])])])]),_:1},8,["visible"])])],64)}}};export{dt as default};
